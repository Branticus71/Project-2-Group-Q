---
title: "Project 2"
author: "Brant Armstrong, Lexi Field, Richard Xiao"
date: "2022-09-28"
output: html_document #Needs to be removed later, keeping it for now to test how the file knits.
---

Packages needed for our functions and data exploration.
```{r, message=FALSE}
library(tidyverse)
library(httr)
library(jsonlite)
library(ggplot2)

#Brant's api key ?apiKey=965047400ad841198f2fd834535db269 and ?apiKey=05671e9eac144e52907ef1a7a7e37874
```

Ideas for functions and analysis:
- Takes in a cuisine, diet, max time to cook, and number of recipes to return matching recipes use sort= random as default. 
  -Analysis could be comparing time to cook across different cuisines and diets. Plot average time to cook for each cuisine/diet. 
- Takes the ID's from the above function and returns nutrition information data as well as the nutrition label widget for a couple recipes.
  -Analysis could be breakdown of micro or macro nutrients by cuisine/diet. So fat content for Asian vs Mediterranean diet.
- Takes in a time frame, calories, diet, and any exclusions and returns a meal plan for that time frame.
  -Compare macronutrients for each diet choice.
- Takes the meal plan recipe ID's and gets the price per day.
  -Compare the prices for different diet meal plans.
- Takes in the meal plan and a selected day and returns the instructions for each meal that day.
- Takes in a type of wine, price, min rating, and number then returns a number of recommended wines.
  -Compare relationship of price and rating
- Takes in ingredients, number of recipes, and returns possible recipes.

# **Functions**


## Recipes for cuisine, diet, time to cook, a vector/list of allergies.

```{r}
get_recipes <- function(cuisine, diet = "N/A", time = 300, number = 100, allergies = "None", API = "238e5276c39d42ceb50a7063db2c7306"){
  
  if(diet == "N/A") {
    url <- paste0("https://api.spoonacular.com/recipes/complexSearch?apiKey=", API, "&cuisine=", cuisine,"&maxReadyTime=", time, "&number=", number, "&sort=random&addRecipeNutrition=true")
  } else{
    url <- paste0("https://api.spoonacular.com/recipes/complexSearch?apiKey=", API, "&cuisine=", cuisine, "&diet=", diet,"&maxReadyTime=", time,"&number=", number, "&sort=random&addRecipeNutrition=true")
  }
  
  
  
  
  allergies <- as.list(allergies)
  allergens <- c("Dairy", "Egg", "Gluten", "Grain", "Peanut", "Seafood", "Sesame", "Shellfish", "Soy", "Sulfite", "Tree Nut", "Wheat")
  if(allergies[1] %in% allergens){
    max = length(allergies)
   for(i in 1:max){
      url <- paste0(url, "&intolerances=", allergies[i])
    }
  }
  
  var_names <- c("pricePerServing", "id", "title", "readyInMinutes", "nutrition", "servings")
  recipe_list <- fromJSON(url)
  recipe_sample <- recipe_list$results %>% select(var_names) %>% mutate(Cuisine = cuisine, Diet = diet)
  return(recipe_sample)
}

Italian_no_diet <- get_recipes("Italian", time = 50)
Italian_Vegan <- get_recipes("Italian", "Vegan", time = 50)
Italian_no_diet
Italian_Vegan

allergy_list <- c("Gluten", "Dairy", "Peanut", "Tree Nut", "Seafood", "Shellfish")
allergy_test <- get_recipes("Italian", time = 50, allergies = allergy_list)
allergy_test

#American Vegan Function

Amerivegan_get_recipes <- function(cuisine="American", diet = "Vegan", time = 300, number = 100, allergies = "None", API = "238e5276c39d42ceb50a7063db2c7306"){
  
  if(diet == "N/A") {
    url <- paste0("https://api.spoonacular.com/recipes/complexSearch?apiKey=", API, "&cuisine=", cuisine,"&maxReadyTime=", time, "&number=", number, "&sort=random&addRecipeNutrition=true")
  } else{
    url <- paste0("https://api.spoonacular.com/recipes/complexSearch?apiKey=", API, "&cuisine=", cuisine, "&diet=", diet,"&maxReadyTime=", time,"&number=", number, "&sort=random&addRecipeNutrition=true")
  }
  
  
  
  
  allergies <- as.list(allergies)
  allergens <- c("Dairy", "Egg", "Gluten", "Grain", "Peanut", "Seafood", "Sesame", "Shellfish", "Soy", "Sulfite", "Tree Nut", "Wheat")
  if(allergies[1] %in% allergens){
    max = length(allergies)
    for(i in 1:max){
      url <- paste0(url, "&intolerances=", allergies[i])
    }
  }
  
  var_names <- c("pricePerServing", "id", "title", "readyInMinutes", "nutrition", "servings")
  recipe_list <- fromJSON(url)
  recipe_sample <- recipe_list$results %>% select(var_names) %>% mutate(Cuisine = cuisine, Diet = diet)
  return(recipe_sample)
}

Amerivegan_get_recipes()

#Keto Function


keto_get_recipes <- function(cuisine="Italian", diet = "Ketogenic", time = 300, number = 100, allergies = "None", API = "238e5276c39d42ceb50a7063db2c7306"){
  
  if(diet == "N/A") {
    url <- paste0("https://api.spoonacular.com/recipes/complexSearch?apiKey=", API, "&cuisine=", cuisine,"&maxReadyTime=", time, "&number=", number, "&sort=random&addRecipeNutrition=true")
  } else{
    url <- paste0("https://api.spoonacular.com/recipes/complexSearch?apiKey=", API, "&cuisine=", cuisine, "&diet=", diet,"&maxReadyTime=", time,"&number=", number, "&sort=random&addRecipeNutrition=true")
  }
  
  
  
  
  allergies <- as.list(allergies)
  allergens <- c("Dairy", "Egg", "Gluten", "Grain", "Peanut", "Seafood", "Sesame", "Shellfish", "Soy", "Sulfite", "Tree Nut", "Wheat")
  if(allergies[1] %in% allergens){
    max = length(allergies)
    for(i in 1:max){
      url <- paste0(url, "&intolerances=", allergies[i])
    }
  }
  
  var_names <- c("pricePerServing", "id", "title", "readyInMinutes", "nutrition", "servings")
  recipe_list <- fromJSON(url)
  recipe_sample <- recipe_list$results %>% select(var_names) %>% mutate(Cuisine = cuisine, Diet = diet)
  return(recipe_sample)
}

keto_get_recipes()


```


## Function to get nutrition from above function properly cleaned and transform data to wide for analysis.

```{r}
clean_nutrition <- function(df){
  var_list <- c("Cuisine", "Diet", "id", "title","pricePerServing", "readyInMinutes", "name", "amount", "unit", "servings" )
  df_long <- df %>% unnest(nutrition) %>% unnest(nutrients) %>% select(var_list)
  df_wide <- df_long %>% pivot_wider(names_from = name, values_from = c(amount, unit ))
  return(df_wide)
}
clean_nutrition(Italian_Vegan)
```

## Wine retrieval function
```{r}

#get_wine <- function(type, price, number = 10, API = "965047400ad841198f2fd834535db269"){

get_wine <- function(type, price= 6000, number = 100, API = "bd2aacb7b0514c5c88cc3ab82a16dc02"){

  url <- paste0("https://api.spoonacular.com/food/wine/recommendation?apiKey=", API, "&wine=", type, "&maxPrice=", price, "&number=", number)
  wine_list <- fromJSON(url)
  wine_rec <- wine_list$recommendedWines %>% 
    select(id, price, averageRating, ratingCount, score) %>% 
    mutate(type = type)
  return(wine_rec)
}

get_wine("merlot", 50)

```

## Get meal plan function from time frame, daily calories, diet, and allergens

```{r}
#Outputs a list containing multiple dataframes. Should combine to one dataframe.
get_plan <- function(time = "week", calories, diet = "N/A", allergies = "None", API = "965047400ad841198f2fd834535db269"){
  
    if(diet == "N/A") {
    url <- paste0("https://api.spoonacular.com/mealplanner/generate?apiKey=", API, "&timeFrame=", time,"&targetCalories=", calories)
  } else{
    url <- paste0("https://api.spoonacular.com/mealplanner/generate?apiKey=", API, "&timeFrame=", time, "&diet=", diet,"&targetCdddfgdfdsfsdfdsalories=", calories)
  }
  
  allergies <- as.list(allergies)
  allergens <- c("Dairy", "Egg", "Gluten", "Grain", "Peanut", "Seafood", "Sesame", "Shellfish", "Soy", "Sulfite", "Tree Nut", "Wheat")
  if(allergies[1] %in% allergens){
   max = length(allergies)
   for(i in 1:max){
      url <- paste0(url, "&exclude=", allergies[i])
    }
  }
  meal_plan <- fromJSON(url)
  return(meal_plan)
}
allergy_list <- c("Gluten", "Dairy", "Peanut", "Tree Nut", "Seafood", "Shellfish")
test_plan <- get_plan(calories = 2000, allergies=allergy_list )
test_plan
```


```{r}

getmacros <- function(mincalories = 0, maxcalories = 2000, minProtein = 0, maxProtein = 700, number = 20, random = TRUE,API = "ca0e515fe1024fd489a76a3d88fcb775"){
  
    url <- paste0("https://api.spoonacular.com/recipes/findByNutrients?apiKey=", API, "&minCalories=", mincalories, "&maxCalories=", maxcalories, "&minProtein=", minProtein, "&maxProtein=",maxProtein, "&number=", number, "&random=", random)
    calories_list <- fromJSON(url)
    new_calories_list <- calories_list%>%select(calories,protein,fat,carbs)
  return(calories_list)
}



getmacros(20,7000,11,800,30)

```

# Ideas for Exploratory Data Analysis
Contingency table: Cuisine as row, diet as columns, number of recipes as values
  -Need to modify first function to return totalResults as well
Numerical Summaries: price at different wine categories - Mean, median, standard deviation 
  -Just set max price to something ridiculously high to get the largest dataset possible
Bar plot: average time to cook for each cuisine
Histogram: Average rating for wine, each box of width 1, so 0-1, 1-2, 2-3, 3-4, 4-5
Box plot: Fat/Carb/Protein content by cuisine
Scatter plot: Price vs rating for wine




## Wine Exploratory Data Analysis

Begins by calling the wine_rec function for 10 different popular wines then combines the results into one dataframe for analysis.
```{r}
wine_list <- c("merlot", "riesling","chardonnay", "sauvignon_blanc", "pinot_noir", "cabernet_sauvignon", "moscato", "champagne", "prosecco", "zinfandel")
wine_rec_df <-wine_list %>%
  lapply(get_wine) %>%
  bind_rows()
wine_rec_df
```

## Cuisine Exploratory Data Analysis

```{r}
cuisine_list <- c("American", "Chinese", "French", "Greek", "Indian", "Italian","Japanese", "Mexican", "Middle Eastern", "Korean")
cuisine_rec_df <- cuisine_list %>%
  lapply(get_recipes) %>%
  lapply(clean_nutrition) %>%
  bind_rows()

cuisine_rec_df





#Plots and Contingency table

ggplot(cuisine_rec_df, aes(x= Cuisine, y=amount_Fat, col = Cuisine)) + geom_boxplot(fill="grey") + geom_jitter()
ggplot(cuisine_rec_df, aes(x = Cuisine, y=amount_Protein, col = Cuisine)) + geom_boxplot(fill="grey") + geom_jitter()
ggplot(cuisine_rec_df, aes(x = Cuisine, y=amount_Carbohydrates, col = Cuisine)) + geom_boxplot(fill="grey") + geom_jitter()
ggplot(cuisine_rec_df, aes(x = Cuisine, y = readyInMinutes))+geom_bar(stat = "Identity") + xlab("Type of Cuisine")

```

