---
title: "Project 2"
author: "Brant Armstrong, Lexi Field, Richard Xiao"
date: "2022-09-28"
output: html_document #Needs to be removed later, keeping it for now to test how the file knits.
---

Packages needed for our functions and data exploration.
```{r, message=FALSE}
library(tidyverse)
library(httr)
library(jsonlite)

#Brant's api keys ?apiKey=965047400ad841198f2fd834535db269 + ?apiKey=05671e9eac144e52907ef1a7a7e37874 +?apiKey=ea88d9f6e2bc470bbddeb6db653f214b
```

Ideas for functions and analysis:
- Takes in a cuisine, diet, max time to cook, and number of recipes to return matching recipes use sort= random as default. 
  -Analysis could be comparing time to cook across different cuisines and diets. Plot average time to cook for each cuisine/diet. 
- Takes the ID's from the above function and returns nutrition information data as well as the nutrition label widget for a couple recipes.
  -Analysis could be breakdown of micro or macro nutrients by cuisine/diet. So fat content for Asian vs Mediterranean diet.
- Takes in a time frame, calories, diet, and any exclusions and returns a meal plan for that time frame.
  -Compare macronutrients for each diet choice.
- Takes the meal plan recipe ID's and gets the price per day.
  -Compare the prices for different diet meal plans.
- Takes in the meal plan and a selected day and returns the instructions for each meal that day.
- Takes in a type of wine, price, min rating, and number then returns a number of recommended wines.
  -Compare relationship of price and rating
- Takes in ingredients, number of recipes, and returns possible recipes.

# **Functions**


## Recipes for cuisine, diet, time to cook, a list of allergies.

```{r}
get_recipes <- function(cuisine, diet = "N/A", time = 300, number = 100, allergies = "None", API = "05671e9eac144e52907ef1a7a7e37874"){
  
  if(diet == "N/A") {
    url <- paste0("https://api.spoonacular.com/recipes/complexSearch?apiKey=", API, "&cuisine=", cuisine,"&maxReadyTime=", time, "&number=", number, "&sort=random&addRecipeNutrition=true")
  } else{
    url <- paste0("https://api.spoonacular.com/recipes/complexSearch?apiKey=", API, "&cuisine=", cuisine, "&diet=", diet,"&maxReadyTime=", time,"&number=", number, "&sort=random&addRecipeNutrition=true")
  }
  
  allergies <- as.list(allergies)
  allergens <- c("Dairy", "Egg", "Gluten", "Grain", "Peanut", "Seafood", "Sesame", "Shellfish", "Soy", "Sulfite", "Tree Nut", "Wheat")
  if(allergies[1] %in% allergens){
    max = length(allergies)
   for(i in 1:max){
      url <- paste0(url, "&intolerances=", allergies[i])
    }
  }
  
  var_names <- c("pricePerServing", "id", "title", "readyInMinutes", "nutrition", "servings")
  recipe_list <- fromJSON(url)
  recipe_sample <- recipe_list$results %>% select(var_names) %>% mutate(Cuisine = cuisine, Diet = diet)
  return(recipe_sample)
}

Italian_no_diet <- get_recipes("Italian", number = 3, time = 50, API = "965047400ad841198f2fd834535db269")
Italian_Vegan <- get_recipes("Italian", "Vegan",number = 3, time = 50, API = "965047400ad841198f2fd834535db269")
Italian_no_diet
Italian_Vegan

allergy_list <- c("Gluten", "Dairy", "Peanut", "Tree Nut", "Seafood", "Shellfish")
allergy_test <- get_recipes("Italian", time = 50, allergies = allergy_list)
allergy_test
```


## Function to get nutrition from recipe_smaple results fropm above function properly cleaned and transformed to wide for analysis.

```{r}
clean_nutrition <- function(df){
  var_list <- c("Cuisine", "Diet", "id", "title","pricePerServing", "readyInMinutes", "name", "amount", "unit", "servings" )
  df_long <- df %>% unnest(nutrition) %>% unnest(nutrients) %>% select(var_list)
  df_wide <- df_long %>% pivot_wider(names_from = name, values_from = c(amount, unit ))
  return(df_wide)
}
clean_nutrition(Italian_Vegan)
```

## Wrapper function for the above two functions which takes in a list of cuisines and outputs a combined and cleaned dataset

```{r}
cuisine_list <- c("American", "Chinese", "French", "Greek", "Indian", "Italian","Japanese", "Mexican", "Middle Eastern", "Korean")
wrapper_recipes <- function(cuisine, diet = "N/A", time = 300, number = 100, allergies = "None", API = "ea88d9f6e2bc470bbddeb6db653f214b" ){
  cuisine_wrap <- lapply(cuisine, get_recipes, diet, time, number, allergies, API)
  clean_wrap <- lapply(cuisine_wrap, clean_nutrition)
  result_wrap <- bind_rows(clean_wrap)
  return(result_wrap)
}
cuisine_rec_df<- wrapper_recipes(cuisine_list, number = 5)
cuisine_rec_df
```

## Recipe total function. Takes in same inputs as first function but returns the number of recipes matching criteria.

```{r}
get_total <- function(cuisine, diet = "N/A", time = 300, number = 100, allergies = "None", API = "05671e9eac144e52907ef1a7a7e37874"){
  
  if(diet == "N/A") {
    url <- paste0("https://api.spoonacular.com/recipes/complexSearch?apiKey=", API, "&cuisine=", cuisine,"&maxReadyTime=", time, "&number=", number, "&sort=random&addRecipeNutrition=true")
  } else{
    url <- paste0("https://api.spoonacular.com/recipes/complexSearch?apiKey=", API, "&cuisine=", cuisine, "&diet=", diet,"&maxReadyTime=", time,"&number=", number, "&sort=random&addRecipeNutrition=true")
  }
  
  allergies <- as.list(allergies)
  allergens <- c("Dairy", "Egg", "Gluten", "Grain", "Peanut", "Seafood", "Sesame", "Shellfish", "Soy", "Sulfite", "Tree Nut", "Wheat")
  if(allergies[1] %in% allergens){
    max = length(allergies)
   for(i in 1:max){
      url <- paste0(url, "&intolerances=", allergies[i])
    }
  }
  recipe_list <- fromJSON(url)
  recipe_total <- recipe_list$totalResults %>% bind_cols() %>% rename(Total = ...1)%>% mutate(Cuisine = cuisine, Diet = diet)
  return(recipe_total)
}

```

## Wine retrieval function
```{r}

get_wine <- function(type, price= 6000, number = 100, API = "05671e9eac144e52907ef1a7a7e37874"){
  url <- paste0("https://api.spoonacular.com/food/wine/recommendation?apiKey=", API, "&wine=", type, "&maxPrice=", price, "&number=", number)
  wine_list <- fromJSON(url)
  wine_rec <- wine_list$recommendedWines %>% 
    select(id, price, averageRating, ratingCount, score) %>% 
    mutate(type = type, averageRating = averageRating * 5, price = parse_number(price))
  return(wine_rec)
}

get_wine("merlot", 50)



```


## Get meal plan function from time frame, daily calories, diet, and allergens

```{r}
#Outputs a list containing multiple dataframes. Should combine to one dataframe.
get_plan <- function(time = "week", calories, diet = "N/A", allergies = "None", API = "965047400ad841198f2fd834535db269"){
  
    if(diet == "N/A") {
    url <- paste0("https://api.spoonacular.com/mealplanner/generate?apiKey=", API, "&timeFrame=", time,"&targetCalories=", calories)
  } else{
    url <- paste0("https://api.spoonacular.com/mealplanner/generate?apiKey=", API, "&timeFrame=", time, "&diet=", diet,"&targetCalories=", calories)
  }
  
  allergies <- as.list(allergies)
  allergens <- c("Dairy", "Egg", "Gluten", "Grain", "Peanut", "Seafood", "Sesame", "Shellfish", "Soy", "Sulfite", "Tree Nut", "Wheat")
  if(allergies[1] %in% allergens){
   max = length(allergies)
   for(i in 1:max){
      url <- paste0(url, "&exclude=", allergies[i])
    }
  }
  meal_plan <- fromJSON(url)
  return(meal_plan)
}
allergy_list <- c("Gluten", "Dairy", "Peanut", "Tree Nut", "Seafood", "Shellfish")
test_plan <- get_plan(calories = 2000, allergies=allergy_list )
test_plan
```


```{r}

getmacros <- function(mincalories = 0, maxcalories = 2000, minProtein = 0, maxProtein = 700, number = 20, random = TRUE,API = "ca0e515fe1024fd489a76a3d88fcb775"){
  
    url <- paste0("https://api.spoonacular.com/recipes/findByNutrients?apiKey=", API, "&minCalories=", mincalories, "&maxCalories=", maxcalories, "&minProtein=", minProtein, "&maxProtein=",maxProtein, "&number=", number, "&random=", random)
    calories_list <- fromJSON(url)
    new_calories_list <- calories_list%>%select(calories,protein,fat,carbs)
  return(calories_list)
}
getmacros(20,7000,11,800,30)

```

# Ideas for Exploratory Data Analysis
Contingency table: Cuisine as row, diet as columns, number of recipes as values
  -Need to modify first function to return a totalResults dataframe as well
Numerical Summaries: price at different wine categories - Mean, median, standard deviation 
  -Just set max price to something ridiculously high to get the largest dataset possible
Bar plot: average time to cook for each cuisine
Histogram: Average rating for wine, each box of width 1, so 0-1, 1-2, 2-3, 3-4, 4-5
Box plot: Fat/Carb/Protein content by cuisine
Scatter plot: Price vs rating for wine




## Wine Exploratory Data Analysis

Begins by calling the wine_rec function for 10 different popular wines then combines the results into one dataframe for analysis.
```{r}
wine_list <- c("merlot", "riesling","chardonnay", "sauvignon_blanc", "pinot_noir", "cabernet_sauvignon", "moscato", "champagne", "prosecco", "zinfandel")
wine_rec_df <-wine_list %>%
  lapply(get_wine) %>%
  bind_rows()
wine_rec_df

```

## Cuisine Exploratory Data Analysis

Creates a dataframe with ten different cuisines using the wrapper function then plots the results.
```{r}
cuisine_list <- c("American", "Chinese", "French", "Greek", "Indian", "Italian","Japanese", "Mexican", "Middle Eastern", "Korean")
cuisine_rec_df <- wrapper_recipes(cuisine_list, number = 100)
cuisine_rec_df




ggplot(cuisine_rec_df, aes(x= Cuisine, y=amount_Fat, col = Cuisine)) + geom_boxplot(fill="grey") + geom_jitter()
ggplot(cuisine_rec_df, aes(x = Cuisine, y=amount_Protein, col = Cuisine)) + geom_boxplot(fill="grey") + geom_jitter()
ggplot(cuisine_rec_df, aes(x = Cuisine, y=amount_Carbohydrates, col = Cuisine)) + geom_boxplot(fill="grey") + geom_jitter()

```



Wine Graphing
Graphing price vs wine rating for different types of wine.
```{r}
library(ggplot2)
gwine <- ggplot(data = wine_rec_df, aes(x = price, y = averageRating,))
gwine + geom_point(aes(color = type), position = "jitter", size = .5) + xlab("price") + ylab("rating") 

```

Graphing average rating for each type of wine
```{r}
library(ggplot2)
gwinerating <- ggplot(data = wine_rec_df, aes(x = type, y = averageRating))
gwinerating + geom_boxplot(fill = "pink") + geom_point(aes(color = type), position = "jitter", size = .5) + theme(axis.text.x = element_text(angle = 45))
```

Creating a contingency table for various cuisines across diets using the `get_total` function
```{r}
diet_list <- c("Gluten Free","Ketogenic","Vegetarian","Vegan","Paleo", "Whole30")

Italian_totals <- diet_list %>% lapply(get_total, cuisine="Italian", API ="bba84b77f7f6471ab5cc81be8acdbe75" ) %>% bind_rows()
American_totals <- diet_list %>% lapply(get_total, cuisine="American", API ="bba84b77f7f6471ab5cc81be8acdbe75" ) %>% bind_rows()
Chinese_totals <- diet_list %>% lapply(get_total, cuisine="Chinese", API ="bba84b77f7f6471ab5cc81be8acdbe75" ) %>% bind_rows()
French_totals <- diet_list %>% lapply(get_total, cuisine="French", API ="bba84b77f7f6471ab5cc81be8acdbe75" ) %>% bind_rows()
Mexican_totals <- diet_list %>% lapply(get_total, cuisine="Mexican", API ="bba84b77f7f6471ab5cc81be8acdbe75" ) %>% bind_rows()
Indian_totals <- diet_list %>% lapply(get_total, cuisine="Indian", API ="bba84b77f7f6471ab5cc81be8acdbe75" ) %>% bind_rows()
Japanese_totals <- diet_list %>% lapply(get_total, cuisine="Japanese", API ="bba84b77f7f6471ab5cc81be8acdbe75" ) %>% bind_rows()

long_totals <- bind_rows(Italian_totals, American_totals, Chinese_totals, French_totals, Mexican_totals, Indian_totals, Japanese_totals )
wide_totals <- pivot_wider(true_totals, names_from = Diet, values_from = Total)

wide_totals
```